<!--pages/favorites/favorites.wxml-->
<view class="page">
  <!-- 头部操作栏 -->
  <view class="header-actions" wx:if="{{favorites.length > 0}}">
    <view class="view-mode">
      <text class="mode-btn {{viewMode === 'grid' ? 'active' : ''}}" bindtap="changeViewMode" data-mode="grid">
        ⚏
      </text>
      <text class="mode-btn {{viewMode === 'list' ? 'active' : ''}}" bindtap="changeViewMode" data-mode="list">
        ☰
      </text>
    </view>
    <view class="sort-options">
      <text class="sort-btn {{sortBy === 'time' ? 'active' : ''}}" bindtap="changeSort" data-sort="time">
        最近收藏
      </text>
      <text class="sort-btn {{sortBy === 'price' ? 'active' : ''}}" bindtap="changeSort" data-sort="price">
        价格排序
      </text>
    </view>
    <text class="edit-btn" bindtap="toggleEditMode">{{editMode ? '完成' : '编辑'}}</text>
  </view>

  <!-- 收藏列表 -->
  <view class="favorites-list" wx:if="{{favorites.length > 0}}">
    <!-- 网格视图 -->
    <view class="grid-view" wx:if="{{viewMode === 'grid'}}">
      <view class="grid-item {{editMode ? 'edit-mode' : ''}}" 
            wx:for="{{favorites}}" 
            wx:key="_id">
        <view class="select-checkbox" wx:if="{{editMode}}" 
              bindtap="toggleSelect" 
              data-id="{{item.motorcycleId}}">
          <text class="checkbox {{selectedItems.indexOf(item.motorcycleId) !== -1 ? 'checked' : ''}}">
            {{selectedItems.indexOf(item.motorcycleId) !== -1 ? '✓' : ''}}
          </text>
        </view>
        <motorcycle-card motorcycle="{{item.motorcycle}}" 
                        bind:cardtap="goToDetail"
                        bind:favoritechange="onFavoriteChange">
        </motorcycle-card>
        <view class="favorite-date">
          <text>收藏于 {{item.addedAt}}</text>
        </view>
        <view class="favorite-notes" wx:if="{{item.notes}}">
          <text>{{item.notes}}</text>
        </view>
      </view>
    </view>

    <!-- 列表视图 -->
    <view class="list-view" wx:if="{{viewMode === 'list'}}">
      <view class="list-item {{editMode ? 'edit-mode' : ''}}" 
            wx:for="{{favorites}}" 
            wx:key="_id"
            bindtap="goToDetail" 
            data-id="{{item.motorcycleId}}">
        <view class="select-checkbox" wx:if="{{editMode}}" 
              bindtap="toggleSelect" 
              data-id="{{item.motorcycleId}}" 
              catchtap="true">
          <text class="checkbox {{selectedItems.indexOf(item.motorcycleId) !== -1 ? 'checked' : ''}}">
            {{selectedItems.indexOf(item.motorcycleId) !== -1 ? '✓' : ''}}
          </text>
        </view>
        <image src="{{item.motorcycle.images[0].url}}" class="motorcycle-image" mode="aspectFill"></image>
        <view class="motorcycle-info">
          <view class="info-header">
            <text class="motorcycle-name">{{item.motorcycle.brand}} {{item.motorcycle.model}}</text>
            <text class="motorcycle-year">{{item.motorcycle.year}}年</text>
          </view>
          <text class="motorcycle-price">¥{{item.motorcycle.price.msrp}}</text>
          <view class="motorcycle-specs">
            <text class="spec-item">{{item.motorcycle.engine.displacement}}cc</text>
            <text class="spec-item">{{item.motorcycle.performance.power.hp}}HP</text>
            <text class="spec-item">{{item.motorcycle.category}}</text>
          </view>
          <view class="favorite-meta">
            <text class="favorite-date">收藏于 {{item.addedAt}}</text>
            <text class="favorite-notes" wx:if="{{item.notes}}">备注：{{item.notes}}</text>
          </view>
        </view>
        <view class="action-buttons" wx:if="{{!editMode}}">
          <text class="compare-btn" bindtap="addToCompare" data-id="{{item.motorcycleId}}" catchtap="true">
            对比
          </text>
          <text class="share-btn" bindtap="shareMotorcycle" data-motorcycle="{{item.motorcycle}}" catchtap="true">
            分享
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- 批量操作栏 -->
  <view class="batch-actions" wx:if="{{editMode && selectedItems.length > 0}}">
    <view class="selected-count">
      <text>已选择 {{selectedItems.length}} 项</text>
    </view>
    <view class="action-buttons">
      <button class="action-btn outline" bindtap="batchCompare">批量对比</button>
      <button class="action-btn danger" bindtap="batchDelete">删除</button>
    </view>
  </view>

  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{hasMore && !loading}}">
    <text class="load-more-text" bindtap="loadMore">加载更多</text>
  </view>

  <!-- 加载中 -->
  <view class="loading" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{favorites.length === 0 && !loading}}">
    <image src="/images/empty-favorites.png" class="empty-icon"></image>
    <text class="empty-title">暂无收藏</text>
    <text class="empty-desc">收藏喜欢的摩托车，方便随时查看</text>
    <button class="empty-action-btn" bindtap="goToList">去看看</button>
  </view>

  <!-- 添加备注弹窗 -->
  <view class="note-modal" wx:if="{{showNoteModal}}">
    <view class="modal-mask" bindtap="hideNoteModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">添加备注</text>
        <text class="modal-close" bindtap="hideNoteModal">✕</text>
      </view>
      <view class="modal-body">
        <textarea class="note-input" 
                  placeholder="为这款摩托车添加备注..." 
                  value="{{noteText}}"
                  bindinput="onNoteInput"
                  maxlength="200">
        </textarea>
        <text class="char-count">{{noteText.length}}/200</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideNoteModal">取消</button>
        <button class="modal-btn confirm" bindtap="saveNote">保存</button>
      </view>
    </view>
  </view>
</view>